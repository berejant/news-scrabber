services:
  parser:
    profiles:
      - go-apps
    build:
      context: .
      dockerfile: Dockerfile
    command: ["/app/parser"]
    depends_on:
      - nats
      - elasticsearch
      - qdrant
      - seaweedfs-master
      - seaweedfs-volume
      - seaweedfs-s3
    environment:
      NATS_URL: "nats://nats:4222"
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
      WHISPER_URL: "http://whisper:10300"
      QDRANT_URL: "http://qdrant:6333"
      S3_ENDPOINT: "http://seaweedfs-s3:8333"
      S3_BUCKET: "my-bucket"
      S3_ACCESS_KEY: "YOUR_ACCESS_KEY"
      S3_SECRET_KEY: "YOUR_SECRET_KEY"

      # ---- OpenTelemetry / OTLP ----
      OTEL_SERVICE_NAME: "parser"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "http://jaeger:4318/v1/traces"
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
      OTEL_RESOURCE_ATTRIBUTES: "service.namespace=my-service,service.instance.id=parser-1"

    restart: unless-stopped

  enricher:
    profiles:
      - go-apps
    build:
      context: .
      dockerfile: Dockerfile
    command: ["/app/enricher"]
    depends_on:
      - nats
      - elasticsearch
      - qdrant
      - seaweedfs-master
      - seaweedfs-volume
      - seaweedfs-s3
    environment:
      NATS_URL: "nats://nats:4222"
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
      QDRANT_URL: "http://qdrant:6333"
      S3_ENDPOINT: "http://seaweedfs-s3:8333"
      S3_BUCKET: "my-bucket"
      S3_ACCESS_KEY: "YOUR_ACCESS_KEY"
      S3_SECRET_KEY: "YOUR_SECRET_KEY"

      # ---- OpenTelemetry / OTLP ----
      OTEL_SERVICE_NAME: "enricher"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "http://jaeger:4318/v1/traces"
      OTEL_TRACES_SAMPLER: "parentbased_always_on"
      OTEL_RESOURCE_ATTRIBUTES: "service.namespace=my-service,service.instance.id=enricher-1"
    restart: unless-stopped

  # NATS з JetStream
  nats:
    image: nats:2.10-alpine
    command:
      - "-js"                         # увімкнути JetStream
      - "-sd"
      - "/data/jetstream"             # збереження стану JS
      - "-m"
      - "8222"                        # порт моніторингу (опційно)
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats-data:/data
    restart: unless-stopped

  whisper:
    build:
      context: ./whisper
      dockerfile: Dockerfile
    environment:
      WHISPER_MODEL: small.en
      WHISPER_DEVICE: cpu
      TORCH_HOME: /models
    volumes:
      - whisper-models:/models
    ports:
      - "10300:10300"
    restart: unless-stopped

  # Elasticsearch (одновузловий для dev)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.0
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      # для спрощення в dev-режимі (відключає безпеку; не для продакшну)
      - xpack.security.enabled=false
      - xpack.security.transport.ssl.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    restart: unless-stopped

  # Qdrant vector DB
  qdrant:
    image: qdrant/qdrant:v1.11.0
    ports:
      - "6333:6333"   # HTTP API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant-data:/qdrant/storage
    restart: unless-stopped

  # SeaweedFS master
  seaweedfs-master:
    image: chrislusf/seaweedfs:3.68
    command: "master -ip=seaweedfs-master -defaultReplication=000"
    ports:
      - "9333:9333"   # master HTTP
    volumes:
      - seaweedfs-master-data:/data
    restart: unless-stopped

  # SeaweedFS volume server
  seaweedfs-volume:
    image: chrislusf/seaweedfs:3.68
    command: "volume -mserver=seaweedfs-master:9333 -ip=seaweedfs-volume -dir=/data -max=0"
    depends_on:
      - seaweedfs-master
    ports:
      - "8080:8080"   # volume HTTP
    volumes:
      - seaweedfs-volume-data:/data
    restart: unless-stopped

  # SeaweedFS S3 gateway
  seaweedfs-s3:
    image: chrislusf/seaweedfs:3.68
    command: "s3 -port=8333 -config=/etc/seaweedfs/s3.json -filer=seaweedfs-filer:8888"
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
      - seaweedfs-filer
    ports:
      - "8333:8333"   # S3 endpoint
    volumes:
      - ./seaweedfs:/etc/seaweedfs:ro
    restart: unless-stopped

  # SeaweedFS filer (потрібен для S3)
  seaweedfs-filer:
    image: chrislusf/seaweedfs:3.68
    command: "filer -master=seaweedfs-master:9333 -ip=seaweedfs-filer -port=8888"
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    ports:
      - "8888:8888"
    volumes:
      - seaweedfs-filer-data:/data
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"
    restart: always
    environment:
      COLLECTOR_OTLP_ENABLED: 'true'

  static-server:
    image: joseluisq/static-web-server:2-alpine
    container_name: static-server
    volumes:
      - ./tests/static:/var/public:ro
    ports:
      - "8383:80"
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.0
    depends_on:
      - elasticsearch
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
    ports:
      - "5601:5601"
    restart: unless-stopped

volumes:
  nats-data:
  es-data:
  qdrant-data:
  seaweedfs-master-data:
  seaweedfs-volume-data:
  seaweedfs-filer-data:
  whisper-models:
